// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  uid              String     @id @default(uuid())
  telegramId       Int        @unique
  username         String     @unique
  urlPhoto         String?
  hashPassword     String
  hashRefreshToken String?
  GameData         GameData[]
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
}

model GameData {
  id              String  @default(uuid())
  uid             String
  shipId          String  @unique
  currentPlanetId String?

  // Позиция игрока в галактике
  x    Float @default(0)
  y    Float @default(0)
  z    Float @default(0)
  user User  @relation(fields: [uid], references: [uid])

  planetVisits   PlanetVisit[]
  balances       Balance[]
  ships          Ship[]
  InventoryItems InventoryItem[]

  @@id([id, uid]) // Составной первичный ключ
  @@unique([id, uid]) // uid остается уникальным
  @@unique([uid]) // uid остается уникальным
}

enum TypeShip {
  STARTER
  CARGO
  BIG_CARGO
}

model Ship {
  id           String   @id @default(uuid())
  level        Int
  type         TypeShip
  // Характеристики корабля
  warpRange    Float    @default(1000) // Макс расстояние прыжка
  warpSpeed    Float    @default(1)
  miningPower  Float    @default(100) // Мощность бура
  cargoSize    Float    @default(100) // Лимит ресурсов в трюме
  locator      Float    @default(3) // Макс сканирование планет
  fuel         Float    @default(100) // текущий запас топлива
  fuelCapacity Float    @default(100) // максимальный запас топлива
  fuelPerUnit  Float    @default(0.01) // расход топлива на 1 единицу расстояния

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  isSelected Boolean  @default(false)

  GameData   GameData? @relation(fields: [gameDataId, uid], references: [id, uid])
  gameDataId String?
  uid        String?

  components ShipComponent[]
}

enum ShipComponentType {
  SCANER
  DRILL
  ENGINE
  WAREHOUSE
}

model ShipComponent {
  id          String            @id @default(uuid())
  name        String
  type        ShipComponentType
  description String
  upgradeCost Json
  level       Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Ship      Ship?    @relation(fields: [shipId], references: [id])
  shipId    String?
  uid       String?
}

enum Rarity {
  COMMON
  UNCOMMON
  RARE
  EPIC
  LEGENDARY
}

enum PlanetType {
  ROCKY //скалистая
  LUSH //
  FROZEN // замершая
  TOXIC // токсичная
  EXOTIC // экзотическая
  BLACKHOLE // черная дыра
}

model Planet {
  id       String     @id @default(uuid())
  seed     String     @unique
  name     String
  type     PlanetType // "Rocky", "Exotic"
  ownerBy  String? // uid (кто сканировал) первооткрыватель
  x        Int
  y        Int
  z        Int
  rarity   Rarity
  depleted Boolean    @default(false)

  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  planetResource PlanetResource[]
  planetVisit    PlanetVisit[]
}

model InventoryItem {
  id    String   @id @default(cuid())
  gamne GameData @relation(fields: [uid], references: [uid])

  resource ResourceType @unique // имя ресурса, например "XenonCrystal"
  amount   Float        @default(0)
  uid      String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum ResourceType {
  COPPER
  CARBON
  SILICON
  ALUMINUM
  TITANIUM
  NICKEL
  COBALT
  URANIUM
  ALPHACREDITS
  GOLD
  PLATINUM
  IRIDIUM
  EXOTICMATTER
  GAMMARSHARDS
  MAGNESIUM
  CALCIUM
  OBSIDIAN
  COAL
  MANGANESE
  CHROMIUM
  ZINC
  TUNGSTEN
  MOLYBDENUM
  RHODIUM
  PALLADIUM
  OSMIUM
  RUTHENIUM
  HELIUM3
  TRITIUM
  DEUTERIUM
  LITHIUM
  BORON
  PHOSPHORUS
  SULFUR
  WATERICE
  AMMONIA
  METHANE
  BETATOKENS
  NAQUADA
  UNOBTANIUM
  KYRIPTONITE
  DILITHIUM
  TRILLIUM
  VERYNIUM
  ADRA
  STRYDIUM
  NEUTRONIUM
  QUANTUMORE
}

// 4. Ресурсы планеты (для finite tracking, вместо Json для запросов)
model PlanetResource {
  id                 String       @id @default(uuid())
  planetId           String
  type               ResourceType // "iron", "alphacredits"
  totalAmount        Float
  current            Float
  drillPowerRequired Float
  rarity             Rarity

  planet Planet @relation(fields: [planetId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 10. История визитов (статистика, ачивки)
model PlanetVisit {
  id        String   @id @default(uuid())
  uid       String
  planetId  String
  mined     Json // {"iron": 1200, "alphacredits": 500}
  exhausted Boolean  @default(false)
  timestamp DateTime @default(now())

  planet   Planet    @relation(fields: [planetId], references: [id], onDelete: Cascade)
  GameData GameData? @relation(fields: [uid], references: [uid])
}

enum CurrencyType {
  ALFA
  BETTA
  OMEGA
}

model Cycle {
  id          String       @id @default(uuid())
  name        String
  description String
  type        CurrencyType
  startDate   DateTime
  endDate     DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum CurrencyAsset {
  ALFA
  BETTA
  OMEGA
}

model Currency {
  id          String        @id @default(uuid())
  name        String        @unique
  symbol      CurrencyAsset @unique // Например, "DMC" для демонической валюты
  description String?

  balance Balance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Balance {
  id         String   @id @default(uuid())
  uid        String
  currencyId String   @unique
  currency   Currency @relation(fields: [currencyId], references: [id])
  amount     Int

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  gameData   GameData? @relation(fields: [gameDataId, uid], references: [id, uid])
  gameDataId String

  @@unique([uid, currencyId])
  @@index([uid])
}

enum MiningStatus {
  PENDING
  IN_PROGRESS
  FINISHED
  CANCELLED
}

model MiningSession {
  id              String       @id @default(uuid())
  uid             String       @unique
  resourceId      String       @unique
  planetId        String       @unique
  planetSeed      String       @unique
  startedAt       DateTime
  status          MiningStatus @default(PENDING)
  lastClaimAt     DateTime     @default(now())
  maxAmount       Float // сколько можно добыть максимум
  mined           Float        @default(0) // сколько уже начислено
  estimatedAmount Float
  miningRate      Float
  finishedAt      DateTime
}
