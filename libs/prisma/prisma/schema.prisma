// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  uid              String  @id @default(uuid())
  telegramId       Int     @unique
  username         String  @unique
  urlPhoto         String?
  hashPassword     String
  hashRefreshToken String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  gameData  GameData? @relation(fields: [uid], references: [uid])

  @@unique([telegramId, uid])
  @@index([uid, telegramId])
}

enum TypeShip {
  STARTER
  CARGO
  BIG_CARGO
}

model Ship {
  id          String     @default(uuid())
  uid         String
  level       Int
  type        TypeShip
  // Характеристики корабля
  warpRange   Float      @default(1000) // Макс расстояние прыжка
  warpSpeed   Float      @default(1)
  miningPower Float      @default(1) // Мощность бура
  cargoSize   Float      @default(100) // Лимит ресурсов в трюме
  warehouse   Warehouse? @relation(fields: [warehouseId], references: [id])

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  gameData       GameData? @relation(fields: [gameDataShipId], references: [shipId])
  gameDataShipId String?
  warehouseId    String?
  isSelected     Boolean   @default(false)

  components ShipComponent[]

  @@id([id, uid])
  @@unique([id, uid])
  @@unique([uid])
}

enum ShipComponentType {
  SCANER
  DRILL
  ENGINE
  WAREHOUSE
}

model ShipComponent {
  id          String            @id @default(uuid())
  name        String
  type        ShipComponentType
  description String
  upgradeCost Json
  level       Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Ship      Ship?    @relation(fields: [shipId, uid], references: [id, uid])
  shipId    String?
  uid       String?
}

model GameData {
  id     Int    @default(autoincrement())
  uid    String @unique
  shipId String @unique

  // Позиция игрока в галактике
  x Float @default(0)
  y Float @default(0)
  z Float @default(0)

  planetVisit   PlanetVisit[]
  User          User[]
  balance       Balance[]
  ship          Ship[]
  InventoryItem InventoryItem[]
}

enum Rarity {
  COMMON
  UNCOMMON
  RARE
  EPIC
  LEGENDARY
}

// склады ресурсов
model Warehouse {
  id            String            @id @default(uuid())
  uid           String            @unique
  level         Int               @default(1) // Уровень склада
  type          ShipComponentType @default(WAREHOUSE) // Тип склада
  shipId        String            @unique // Уникальная связь (только один склад на санаторий) // ID санатория
  foodQuantity  Int               @default(0) // Количество еды на складе
  coalQuantity  Int               @default(0) // Количество угля
  waterQuantity Int               @default(0) // Количество воды
  herbsQuantity Int               @default(0) // Количество трав
  paperQuantity Int               @default(0) // Количество бумаги
  upgradeCost   Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ship      Ship[]
}

enum PlanetType {
  ROCKY //скалистая
  LUSH //
  FROZEN // замершая
  TOXIC // токсичная
  EXOTIC // экзотическая
  BLACKHOLE // черная дыра
}

model Planet {
  id            String     @id @default(uuid())
  seed          String     @unique
  name          String
  type          PlanetType // "Rocky", "Exotic"
  totalCapacity Json // {"iron": 50000, "alphacredits": 20000}
  currentStock  Json // {"iron": 42500, "alphacredits": 18000}
  scannedBy     String? // uid (кто сканировал) первооткрыватель
  coordinates   Json
  rarity        Rarity
  depleted      Boolean    @default(false)

  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  planetResource PlanetResource[]
  planetVisit    PlanetVisit[]
}

model InventoryItem {
  id    String   @id @default(cuid())
  gamne GameData @relation(fields: [uid], references: [uid])

  resource ResourceType // имя ресурса, например "XenonCrystal"
  amount   Float        @default(0)
  uid      String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum ResourceType {
  COPPER
  CARBON
  SILICON
  ALUMINUM
  TITANIUM
  NICKEL
  COBALT
  URANIUM
  ALPHACREDITS
  GOLD
  PLATINUM
  IRIDIUM
  EXOTICMATTER
  GAMMARSHARDS
  MAGNESIUM
  CALCIUM
  OBSIDIAN
  COAL
  MANGANESE
  CHROMIUM
  ZINC
  TUNGSTEN
  MOLYBDENUM
  RHODIUM
  PALLADIUM
  OSMIUM
  RUTHENIUM
  HELIUM3
  TRITIUM
  DEUTERIUM
  LITHIUM
  BORON
  PHOSPHORUS
  SULFUR
  WATERICE
  AMMONIA
  METHANE
  BETATOKENS
  NAQUADA
  UNOBTANIUM
  KYRIPTONITE
  DILITHIUM
  TRILLIUM
  VERYNIUM
  ADRA
  STRYDIUM
  NEUTRONIUM
  QUANTUMORE
}

// 4. Ресурсы планеты (для finite tracking, вместо Json для запросов)
model PlanetResource {
  id                 String       @id @default(uuid())
  planetId           String
  typeResource       ResourceType // "iron", "alphacredits"
  totalAmount        Float
  current            Float
  drillPowerRequired Float

  planet Planet @relation(fields: [planetId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 10. История визитов (статистика, ачивки)
model PlanetVisit {
  id        String   @id @default(uuid())
  uid       String
  planetId  String
  mined     Json // {"iron": 1200, "alphacredits": 500}
  exhausted Boolean  @default(false)
  timestamp DateTime @default(now())

  planet      Planet    @relation(fields: [planetId], references: [id], onDelete: Cascade)
  GameData    GameData? @relation(fields: [gameDataUid], references: [uid])
  gameDataUid String?
}

enum CurrencyType {
  ALFA
  BETTA
  OMEGA
}

model Cycle {
  id          String       @id @default(uuid())
  name        String
  description String
  type        CurrencyType
  startDate   DateTime
  endDate     DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum CurrencyAsset {
  ALFA
  BETTA
  OMEGA
}

model Currency {
  id          String        @id @default(uuid())
  name        String        @unique
  symbol      CurrencyAsset @unique // Например, "DMC" для демонической валюты
  description String?

  balance Balance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Balance {
  id         String   @id @default(uuid())
  uid        String
  currencyId String   @unique
  currency   Currency @relation(fields: [currencyId], references: [id])
  amount     Int

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  gameData       GameData? @relation(fields: [gameDataShipId], references: [shipId])
  gameDataShipId String?

  @@unique([uid, currencyId])
  @@index([uid])
}

enum MiningStatus {
  PENDING
  IN_PROGRESS
  FINISHED
  CANCELLED
}

model MinigSession {
  id              String       @id @default(uuid())
  uid             String       @unique
  resourceId      String       @unique
  planetId        String       @unique
  planetSeed      String       @unique
  startedAt       DateTime
  status          MiningStatus @default(PENDING)
  estimatedAmount Float
  finishedAt      DateTime?
}
